<?php
drupal_session_start();  
global $user;

function dc_gift_vouchers_form_alter(&$form, &$form_state, $form_id) {
    
   if($form_id == 'dc_gift_vouchers_node_form' && $form['nid']['#value'] == ''){  
       //print "<pre>"; print_r($form); die();
       $userWishlistId = arg(1);
       $form['select_currency_gift_voucher']['#weight'] = -1;
       $form['select_amount_gift_voucher']['#weight'] = 0;
       $form['title']['#weight'] = 1;
       $form['your_message_gift_voucher']['#weight'] = 2;

       $form['select_amount_gift_voucher']['und']['#default_value'] = 10;
       $form['select_currency_gift_voucher']['und']['#default_value'] ="USD";
      
        hide($form['receiver_user_id_gift_voucher']);
        hide($form['wishlist_id_gift_voucher']); 
        hide($form['order_id_gift_voucher']);
        
       $form['wishlist_id_gift_voucher']['und'][0]['value']['#default_value'] = $userWishlistId;
       $getUserId = db_query("SELECT uid FROM wishlist WHERE wishlist_id ='".$userWishlistId."'");
       foreach($getUserId AS $wishlistUser){
           $userId = $wishlistUser->uid;
       }
       $form['receiver_user_id_gift_voucher']['und'][0]['value']['#default_value'] = $userId;
	   $form['order_id_gift_voucher']['und'][0]['value']['#default_value'] = 0;
       $form['actions']['submit']['#value'] = 'Send';
       unset($form['actions']['preview']);
       
   }
}
function dc_gift_vouchers_node_submit($node, $form, &$form_state) {
	
 $email_content = get_mail_content();
	$params = array('body' => $email_content);
	$key = 'dc_gift_vouchers_email';
	$to = 'soni.kamal@antechindia.com';
	$from = 'support@deliverycode.com';
	$mail = drupal_mail('dc_gift_vouchers', $key, $to, language_default(), $params, $from);	
	//print "<pre>"; print_r($form); die();
	//if($form['#form_id'] == 'dc_gift_vouchers_node_form'){
		//if($node->type == 'dc_gift_vouchers' && $node->nid == ''){
			//die('hi');
	    //    node_save($node);
		//	$_SESSION['gift_voucher_nid'] = $node->nid;
	    //    $product = commerce_product_load_by_sku('dc_gift_voucher');
	   //     commerce_cart_product_add_by_id($product->product_id);
	    //    drupal_goto('cart');		
	//	}
	//}
 
}

function dc_gift_vouchers_mail($key, &$message, $params) {
	$language = $message['language'];
	switch ($key) {
	//switching on $key lets you create variations of the email based on the $key parameter
	case 'test_email':
	$message['subject'] = t('Test Email');
	//the email body is here, inside the $message array
	$message['body'][] = $params['body'];
	break;
	}
}

function get_mail_content() {
 
$email_to = 'soni.kamal@antechindia.com';
$pos = strpos($email_to, '@');
$user_name = substr($email_to, 0, $pos);
$body = '';
$body .= 'Hi ' . $user_name . '<br>';
$body .= 'Please find my test email. <br>';
$body .= 'Hi this is a test email soni<br>';
$body .= 'Thanks<br>';
$body .= 'TestTeam';
return $body;
}

function dc_gift_vouchers_commerce_cart_line_item_refresh($line_item, $order_wrapper){ 
   // print "<pre>"; print_r($line_item->order_id); die();
    if ($line_item->line_item_label == 'dc_gift_voucher') {
    	
			if(isset($_SESSION['gift_voucher_nid']) && $_SESSION['gift_voucher_nid'] != ''){
			$user_node_del = '';
			$select_user_bal_node = db_query('SELECT entity_id FROM field_data_order_id_user_bal_update WHERE order_id_user_bal_update_value ='.$line_item->order_id);
			foreach($select_user_bal_node AS $res_user_bal_node){
				 $user_node_del = $res_user_bal_node->entity_id;
			}
			if($user_node_del != ''){
				node_delete($user_node_del);
			}
			
							
					db_update('field_data_order_id_gift_voucher')
					->fields(array('order_id_gift_voucher_value' => 0))
				    ->condition('order_id_gift_voucher_value', $line_item->order_id)
				    ->execute();
				
							
					db_update('field_data_order_id_gift_voucher')
					->fields(array('order_id_gift_voucher_value' => $line_item->order_id))
				    ->condition('entity_id', $_SESSION['gift_voucher_nid'])
				    ->execute();			
					unset($_SESSION['gift_voucher_nid']);
				}
				
				field_cache_clear(TRUE);		
		
		
    	$gv_node = '';

			$select_gv_node = db_query('SELECT entity_id FROM field_data_order_id_gift_voucher WHERE order_id_gift_voucher_value ='.$line_item->order_id);
			foreach($select_gv_node AS $res_gv_node){
				 $gv_node = $res_gv_node->entity_id;
			}			
			$node = node_load($gv_node);
			//print "<pre>"; print_r($node); die('hi');


			$gift_voucher_value = $node->select_amount_gift_voucher['und'][0]['value'];
			$gift_voucher_currency = $node->select_currency_gift_voucher['und'][0]['value'];		

        $price = 100 * $gift_voucher_value; //1 dollar
        $currency_rates_nid = '';
		$select_currency_rates_nid = db_query("SELECT nid FROM node WHERE type ='currency_exchange_rates_for_gift' ORDER BY nid ASC LIMIT 1");
		foreach($select_currency_rates_nid AS $res_currency_rates){
			$currency_rates_nid = $res_currency_rates->nid;
		}
        
        if($gift_voucher_value < 25){
        	
        	$giftVoucherRate = db_query("SELECT field_dc_fee_25_value AS rate FROM field_data_field_dc_fee_25 WHERE entity_id='".$currency_rates_nid."'");
			
        }elseif($gift_voucher_value >= 25 && $gift_voucher_value < 50){
        	
        	$giftVoucherRate = db_query("SELECT field_dc_fee_25_00_49_99_value AS rate FROM field_data_field_dc_fee_25_00_49_99 WHERE entity_id='".$currency_rates_nid."'");

        }elseif($gift_voucher_value >= 50 && $gift_voucher_value < 100){
        	
        	$giftVoucherRate = db_query("SELECT field_dc_fee_50_00_99_99_value AS rate FROM field_data_field_dc_fee_50_00_99_99 WHERE entity_id='".$currency_rates_nid."'");

        }elseif($gift_voucher_value >= 100){
        	
        	$giftVoucherRate = db_query("SELECT field_dc_fee_100__value AS rate FROM field_data_field_dc_fee_100_ WHERE entity_id='".$currency_rates_nid."'");

        }
    	$giftRate = '';
	       foreach($giftVoucherRate AS $resGiftVoucherRate){
	           $giftRate = $resGiftVoucherRate->rate;
	       }
		   
		$rate = $giftRate;        
        $fee = ($gift_voucher_value * $rate) / 100;
        $deliveryCodeFee = $fee * 100;
        $line_item->commerce_unit_price[LANGUAGE_NONE]['0']['amount']=$price;
        $line_item->commerce_unit_price[LANGUAGE_NONE]['0']['currency_code']=$gift_voucher_currency;
        //alter the base_price component
        $line_item->commerce_unit_price[LANGUAGE_NONE]['0']['data']['components']['0']['price']['amount']=$price;
        $line_item->commerce_unit_price[LANGUAGE_NONE]['0']['data']['components']['0']['price']['currency_code']=$gift_voucher_currency;        
        $line_item->commerce_unit_price[LANGUAGE_NONE]['0']['data']['components']['1']['price']['amount']=$deliveryCodeFee;
        $line_item->commerce_unit_price[LANGUAGE_NONE]['0']['data']['components']['1']['price']['currency_code']=$gift_voucher_currency;
        
        //unset($_SESSION['gift_voucher_value']);
    }

}



function dc_gift_vouchers_commerce_checkout_pane_info_alter(&$checkout_pane) {
	//print "<pre>"; print_r($checkout_pane); die();
    $order_id = arg(1);
	$productType = '';
    $getProductType = db_query("SELECT line_item_label  FROM commerce_line_item WHERE  order_id='".$order_id."'");
       foreach($getProductType AS $resProductType){
           $productType = $resProductType->line_item_label;
       }
       if($productType == 'dc_gift_voucher'){ 
            unset($checkout_pane['customer_profile_billing']);
            unset($checkout_pane['commerce_shipping']);
			unset($checkout_pane['commerce_fieldgroup_pane__group_gift_message']);

       }

}

function dc_gift_vouchers_commerce_payment_transaction_presave($transaction) {
	global $user;
	if($transaction->status == 'success'){
		
		$order = commerce_order_load($transaction->order_id);

		$select_order_type = db_query('SELECT line_item_label FROM commerce_line_item WHERE order_id ='.$transaction->order_id);
		foreach($select_order_type AS $res_order_type){
			$order_type = $res_order_type->line_item_label;
		}
		
		$select_currency_rates_nid = db_query("SELECT nid FROM node WHERE type ='currency_exchange_rates_for_gift' ORDER BY nid ASC LIMIT 1");
		foreach($select_currency_rates_nid AS $res_currency_rates){
			$currency_rates_nid = $res_currency_rates->nid;
		}
				
		//print $order_type; die();		
		if($order_type == 'dc_gift_voucher'){


			
			$select_gv_node = db_query('SELECT entity_id FROM field_data_order_id_gift_voucher WHERE order_id_gift_voucher_value ='.$transaction->order_id);
			foreach($select_gv_node AS $res_gv_node){
				 $gv_node = $res_gv_node->entity_id;
			}			
			$node = node_load($gv_node);
			//print "<pre>"; print_r($node); die('hi');


			$user_id = $node->receiver_user_id_gift_voucher['und'][0]['value'];
			$amount = $node->select_amount_gift_voucher['und'][0]['value'];
			$currency = $node->select_currency_gift_voucher['und'][0]['value'];
			
			$select_user_balace = db_query('SELECT field_gift_balance_usd_value FROM field_data_field_gift_balance_usd WHERE entity_id ='.$user_id);
			foreach($select_user_balace AS $res_balance){
				$usd_balance = $res_balance->field_gift_balance_usd_value;
			}
			if($usd_balance == ''){
				
				if($currency == 'USD'){
					
					$user_balance = $amount;			
					
				}else if($currency == 'GBP'){
					
					$usd_vs_gbp = db_query("SELECT field__1_gbp_value FROM field_data_field__1_gbp WHERE entity_id ='".$currency_rates_nid."'");
					foreach($usd_vs_gbp AS $res_usd_vs_gbp){
						$gbp_rate = $res_usd_vs_gbp->field__1_gbp_value;
					}
									
					$amount_usd = number_format(($amount / $gbp_rate), 2);
					$user_balance = $amount_usd;
					
				}else if($currency == 'EUR'){
					
					$usd_vs_eur = db_query("SELECT field__1_eur_value FROM field_data_field__1_eur WHERE entity_id ='".$currency_rates_nid."'");
					foreach($usd_vs_eur AS $res_usd_vs_eur){
						$eur_rate = $res_usd_vs_eur->field__1_eur_value;
					}
					
					$amount_eur = number_format(($amount / $eur_rate), 2);
					$user_balance =  $amount_eur;
					
				}				
				$user_balance = number_format(($user_balance), 2);
				db_query("INSERT INTO field_data_field_gift_balance_usd (entity_type, bundle, deleted, entity_id, revision_id, language, delta, field_gift_balance_usd_value, field_gift_balance_usd_format) VALUES ('user', 'user', 0, '".$user_id."', '".$user_id."', 'und', 0, '".$user_balance."', 'NULL')");
				
				
				field_cache_clear(TRUE);
				
			}else{
				
				if($currency == 'USD'){
					
					$user_balance = number_format(($usd_balance + $amount), 2);			
					
				}else if($currency == 'GBP'){
					
					$usd_vs_gbp = db_query("SELECT field__1_gbp_value FROM field_data_field__1_gbp WHERE entity_id ='".$currency_rates_nid."'");
					foreach($usd_vs_gbp AS $res_usd_vs_gbp){
						$gbp_rate = $res_usd_vs_gbp->field__1_gbp_value;
					}
									
					$amount_usd = number_format(($amount / $gbp_rate), 2);
					$user_balance = $usd_balance + $amount_usd;
					
				}else if($currency == 'EUR'){
					
					$usd_vs_eur = db_query("SELECT field__1_eur_value FROM field_data_field__1_eur WHERE entity_id ='".$currency_rates_nid."'");
					foreach($usd_vs_eur AS $res_usd_vs_eur){
						$eur_rate = $res_usd_vs_eur->field__1_eur_value;
					}
					
					$amount_eur = number_format(($amount / $eur_rate), 2);
					$user_balance = $usd_balance + $amount_eur;
					
				}
				$user_balance = number_format(($user_balance), 2);
				db_update('field_data_field_gift_balance_usd')
				->fields(array('field_gift_balance_usd_value' => $user_balance))
			    ->condition('entity_id', $user_id)
			    ->execute();
				
								
				field_cache_clear(TRUE);			
			}		
			
		}

		
	}
}

?>
